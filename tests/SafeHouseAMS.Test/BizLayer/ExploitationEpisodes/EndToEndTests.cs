using System;
using System.Threading;
using System.Threading.Tasks;
using AutoMapper;
using FluentAssertions;
using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using SafeHouseAMS.BizLayer.ExploitationEpisodes;
using SafeHouseAMS.BizLayer.ExploitationEpisodes.Commands;
using SafeHouseAMS.DataLayer;
using SafeHouseAMS.DataLayer.Repositories;
using Xunit;
using Xunit.Categories;

namespace SafeHouseAMS.Test.BizLayer.ExploitationEpisodes
{
    public class EndToEndTests
    {
        private IMapper CreateMapper()
        {
            var cfg = new MapperConfiguration(c => c.AddMaps(typeof(EpisodesRepository).Assembly));
            return new Mapper(cfg);
        }

        private DataContext CreateInMemoryDatabase()
        {
            var connection = new SqliteConnection("Filename=:memory:");
            connection.Open();
            var dbctxOptsBuilder = new DbContextOptionsBuilder()
                .UseLazyLoadingProxies()
                .UseSqlite(connection, opt =>
                    opt.MigrationsAssembly(typeof(DataContext).Assembly.FullName));
            var ctx = new DataContext(dbctxOptsBuilder.Options);
            ctx.Database.EnsureDeleted();
            ctx.Database.EnsureCreated();
            return ctx;
        }

        [Fact, IntegrationTest]
        public async Task CreateEpisodeCommand_WhenApplied_CreatesEpisode()
        {
            //arrange
            var dbContext = CreateInMemoryDatabase();
            var repo = new EpisodesRepository(dbContext, CreateMapper());
            var bizLogic = new EpisodesCatalogue(repo);

            var survivorId = Guid.NewGuid();
            dbContext.Survivors.Add(new() { ID = survivorId, Name = "name", Num = 42});
            await dbContext.SaveChangesAsync();

            var contactReason = new ContactReason(
            new("involvement"),
            new("cse", CseType.Consummation),
            new("forced labour", ForcedLabourType.Agriculture),
            new("forced marriage", ForcedMarriageKind.Committed),
            new("cre"),
            new("begging"),
            new("forced criminal", CriminalActivityType.Other),
            new("other exploitation"),
            new("sexual violence"),
            new("domestic violence"),
            new("other violence"));
            var controlMethods = new ControlMethods(ControlMethodKind.Alcoholization, DebtKind.Embezzlement, "other");

            var sut = new CreateEpisode(Guid.NewGuid(), survivorId, contactReason, "place", "involvement details",
            false, TimeSpan.FromDays(30), controlMethods, EscapeStatus.PoliceReleased);

            //act
            await bizLogic.ApplyCommand(sut, CancellationToken.None);
            var result = await bizLogic.GetSingleAsync(sut.EntityID, CancellationToken.None);

            //assert
            result.Should().NotBeNull();
            result!.ContactReason.Should().BeEquivalentTo(contactReason);
            result.ControlMethods.Should().BeEquivalentTo(controlMethods);
            result.Place.Should().Be("place");
            result.InvolvementDescription.Should().Be("involvement details");
            result.WasJuvenile.Should().BeFalse();
            result.Duration.Should().Be(TimeSpan.FromDays(30));
            result.EscapeStatus.Should().Be(EscapeStatus.PoliceReleased);
        }
    }
}
